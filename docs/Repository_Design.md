# AGF (Adaptive Governance Framework) Project Design

## 1. Introduction

This document outlines the design principles and structure of the AGF (Adaptive Governance Framework) project. It covers
the repository layout, the purpose of key directories, and the architecture of the `agf` command-line interface (CLI)
tool. The goal is to provide a clear understanding for developers contributing to the project and for end-users seeking
to understand its inner workings.

## 2. Repository Design

The AGF repository is structured to promote clarity, maintainability, and ease of development, following common Go
project layout conventions where applicable.

### 2.1. Overall Philosophy

* **Modularity:** Code is organized into logical packages, primarily within the `cmd/` directory for the CLI.
* **Separation of Concerns:** CLI logic, core business logic (posture generation, building), and utility functions are
  kept distinct where possible.
* **Testability:** The structure aims to facilitate unit and integration testing. Test files (`_test.go`) are co-located
  with the code they test.
* **Automation:** CI/CD processes are managed via GitHub Actions, with workflow definitions in the `.github/workflows` directory.

### 2.2. Folder Structure

Below is a description of the key folders and their intended purpose within the AGF repository:

adaptive-governance-framework/
├── .bin/
│   └── agf/         # Binaries pulled and executed by pre-commit (run_agf.sh) as a cache
├── .github/
│   └── workflows/   # GitHub Actions CI/CD workflow definitions (e.g., testing, coverage)
├── build/           # Output directory for generated files
│   └── postures/    # Default location for generated Terraform posture files
│   └── mappings/    # Default location for generated policy mapping files
├── cmd/             # Main application code for the 'agf' CLI
│   ├── root.go       # Defines the root command for the CLI (e.g., 'agf')
│   ├── new_posture.go # Logic for the 'agf new-posture' subcommand
│   ├── build.go       # Logic for the 'agf build' subcommand
│   └── ...            # Other subcommands and shared CLI utilities
├── detectors/          # Where policy engineers author and manage policies
│   ├── customorgpolicy  # Define custom org policies here
│   ├── customsha       # Define custom SHA modules here
│   ├── orgpolicy      # Define standard org policies here
│   └── sha            # Define standard SHA modules here
├── docs
│   └── ...          # All repository documentation
├── scripts/         # Helper scripts for development, testing, etc.
├── main.go          # Main entry point for the CLI application.
├── go.mod           # Go module definition file.
├── go.sum           # Go module checksum file.
└── README.md        # Project overview, setup instructions, and usage examples.

* **`.github/workflows/`**: Contains YAML files that define GitHub Actions workflows for continuous integration,
  testing, code coverage reporting, and potentially releases.
* **`build/`**: This directory is the default output location for artifacts generated by the `agf` tool.
  * `postures/`: Stores the Terraform posture files created by `agf new-posture` and potentially modified by `agf build`.
  * `mappings/`: Stores policy mapping information generated by `agf build`.
* **`cmd/`**: This is the heart of the `agf` CLI application.
  * Each `.go` file typically represents a command or a group of related commands (e.g., `new_posture.go` for the
    `new-posture` subcommand).
  * It uses the [Cobra CLI library](https://cobra.dev/) for structuring commands, subcommands, and flags.
  * `root.go` initializes the main `agf` command that other subcommands attach to.
* **detectors/**
  * Contains four sub-folders, each named after the four types of detectors you can assign in a SCCE posture (Org
    Policies, Custom Org Policies, SHA Modules, and Custom SHA modules). You can populate this directory with SCCE
    detectors for each category.
  * Each detector directory must contain a policy and metadata file. The policy file is a representation of the policy
    you wish to implement, and the metadata file determines several key factors of that policy, including its ID,
    description, and security framework mappings. **Most importantly, the metadata file determines which postures this
    policy will ultimately become a part of.**
* **scripts/**
  * Contains helper scripts that are used by Github Actions Workflows and pre-commit configurations.
* **`main.go`**: The main application entry point. It typically contains a minimal `main()` function that executes the
  root Cobra command (e.g., `cmd.Execute()`).
* **`go.mod` & `go.sum`**: Manage project dependencies.
* **`README.md`**: Provides essential information for users and developers.

## 3. `agf` CLI Tool Design

The `agf` CLI is designed to be intuitive and powerful, enabling users to manage Adaptive Governance Framework
components efficiently.

### 3.1. Core Technology

* **Go (Golang):** The CLI is written in Go, chosen for its performance, strong standard library, and suitability for
  building robust command-line tools.
* **Cobra CLI:** [Cobra](https://cobra.dev/) is a popular Go library for creating CLI applications. It provides a
  framework for:
  * Defining commands and subcommands.
  * Parsing flags and arguments.
  * Generating help text and usage information.
  * Autocompletion.

### 3.2. Command Structure

The `agf` CLI follows a hierarchical command structure:

* **Root Command:** `agf`
  * This is the entry point for all functionality. Running `agf` by itself or with `-h`/`--help` will display general
    help and available subcommands.

* **Subcommands:**
  * **`agf new-posture [flags]`**:
    * **Purpose:** Generates the boilerplate Terraform files for a new security posture.
    * **Key Flags:**
      * `--name` / `-n`: (Required) The unique name for the posture file.
      * `--description` / `-d`: (Required) A description for the posture.
      * `--parent` / `-p`: (Required) The parent resource in GCP (e.g., `organizations/123`) where the posture resource
        itself will be defined.
      * `--target` / `-t`: (Required) The GCP resource (e.g., `organizations/123`, `folders/456`) that the posture will
        target for deployment.
    * **Output:** Creates a `.tf` file in the `build/postures/` directory based on a predefined template.

  * **`agf build [flags]`**:
    * **Purpose:** Processes existing Terraform posture files and policy definitions to inline policies and
      generate/update policy mapping information.
    * **Key Flags:**
      * `--terraform` / `-t`: If specified, only performs the Terraform build steps (e.g., inlining policies into `.tf` files).
      * `--mappings` / `-m`: If specified, only generates or regenerates policy mapping information in the
        `build/mappings/` directory.
      * If no flags are provided, both Terraform build and mapping generation are performed.
    * **Input:** Reads Terraform files from `build/postures/` and potentially policy definition files from another
      configured location.
    * **Output:** Modifies `.tf` files in `build/postures/` and creates/updates files in `build/mappings/`.

  * *(Other subcommands can be added here as the tool evolves.)*

### 3.3. Design Principles for CLI Commands

* **Clarity:** Command names and flags should be descriptive and easy to understand.
* **Consistency:** Flag names and behavior should be consistent across different commands where applicable.
* **Required Flags:** Cobra's `MarkFlagRequired` is used to ensure users provide necessary information.
* **Helpful Output:** Commands provide informative messages on success or clear error messages on failure, including
  usage hints.
* **Idempotency (where applicable):** Operations like `build` should ideally be idempotent, meaning running them
  multiple times with the same inputs yields the same result without unintended side effects.

## 4. Github Actions Workflows

A collection of Github Actions Workflows exists to ensure that posture files are well-defined, structurally accurate,
and vetted. These workflows ensure that policy logic works as intended, that policies of all types have been properly
added/modified in their respective posture resources, and that the repository's scripting and workflows are operating as
intended.

For more information about these workflows, please see [Github Actions](Github_Actions.md).

## 5. Future Considerations (Example)

* **Configuration File:** Introduce a global or project-level configuration file for `agf` to manage default paths,
  output settings, etc.
* **Plugin System:** For extending functionality with custom policy types or build steps.
* **State Management:** If the tool needs to track the state of managed resources or operations.

---

This document provides a foundational overview. It should be updated as the AGF project evolves.
